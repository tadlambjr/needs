<div class="max-w-3xl mx-auto">
  <div class="mb-6">
    <%= link_to needs_path, class: "inline-flex items-center text-teal-600 hover:text-teal-800" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back
    <% end %>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
    <h1 class="text-3xl font-bold mb-2">Create New Need or Event</h1>
    <p class="text-gray-600 dark:text-gray-400 mb-6">Choose the type below to get started</p>

    <%= form_with model: @need, class: "space-y-6", data: { controller: "time-slot recurring-need content-type" } do |f| %>
      <%= render "shared/form_errors", object: @need %>

      <!-- Content Type -->
      <div class="border-2 border-teal-500 rounded-lg p-4 bg-teal-50 dark:bg-teal-900/20">
        <%= f.label :content_type, "What would you like to create?", class: "block text-base font-semibold mb-3" %>
        <%= f.select :content_type,
            options_for_select([
              ['Need (Volunteer Opportunity)', 'need'],
              ['Event (RSVP)', 'event']
            ], @need.content_type),
            {},
            class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 font-medium",
            data: { action: "change->content-type#toggle", content_type_target: "select" } %>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
          <strong>Need:</strong> Volunteer opportunities where people can sign up to help<br>
          <strong>Event:</strong> Gatherings or activities where people can RSVP to attend
        </p>
      </div>

      <!-- Title -->
      <div>
        <%= f.label :title, class: "block text-sm font-medium mb-2" %>
        <%= f.text_field :title, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700", placeholder: "e.g., Help with yard work" %>
      </div>

      <!-- Description -->
      <div>
        <%= f.label :description, class: "block text-sm font-medium mb-2" do %>
          Description <span class="text-gray-500 font-normal">(Optional)</span>
        <% end %>
        <%= f.text_area :description, rows: 4, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700", placeholder: "Describe what help is needed..." %>
      </div>

      <!-- Category -->
      <div>
        <%= f.label :category_id, "Category", class: "block text-sm font-medium mb-2" %>
        <%= f.collection_select :category_id, @categories, :id, :name, { prompt: "Select a category" }, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Date Range -->
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <%= f.label :start_date, class: "block text-sm font-medium mb-2" %>
          <%= f.date_field :start_date, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
        </div>
        <div>
          <%= f.label :end_date, class: "block text-sm font-medium mb-2" %>
          <%= f.date_field :end_date, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
          <p class="text-xs text-gray-500 mt-1">For recurring needs, leave blank to default to 52 weeks</p>
        </div>
      </div>

      <!-- Time Slot -->
      <div>
        <%= f.label :time_slot, class: "block text-sm font-medium mb-2" %>
        <%= f.select :time_slot, 
            options_for_select([
              ['Morning (6am-12pm)', 'morning'],
              ['Afternoon (12pm-6pm)', 'afternoon'],
              ['Evening (6pm-10pm)', 'evening'],
              ['All Day', 'all_day'],
              ['Specific Time', 'specific_time']
            ]), 
            { include_blank: "Select time slot" }, 
            class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700",
            data: { action: "change->time-slot#toggle" } %>
      </div>

      <!-- Specific Time (shown when time_slot is specific_time) -->
      <div data-time-slot-target="specificTime" class="hidden">
        <%= f.label :specific_time, class: "block text-sm font-medium mb-2" %>
        <%= f.time_field :specific_time, 
            data: { time_slot_target: "timeInput" },
            class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
        <p class="text-sm text-gray-500 mt-1">Enter the specific time for this need</p>
      </div>

      <!-- Location -->
      <div>
        <%= f.label :location, class: "block text-sm font-medium mb-2" %>
        <%= f.text_field :location, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700", placeholder: "e.g., 123 Main St or Church Building" %>
      </div>

      <!-- Volunteer/Attendee Capacity -->
      <div>
        <%= f.label :volunteer_capacity, class: "block text-sm font-medium mb-2" do %>
          <span data-content-type-target="capacityLabel">Number of Volunteers Needed</span>
        <% end %>
        <%= f.number_field :volunteer_capacity, min: 1, max: 20, value: 1, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Multi-day signup (Needs only) -->
      <div data-content-type-target="mealTrain" class="flex items-start">
        <%= f.check_box :allow_individual_day_signup, class: "mt-1 mr-2" %>
        <div>
          <%= f.label :allow_individual_day_signup, "Allow volunteers to sign up for individual days (Meal Train)", class: "font-medium" %>
          <p class="text-sm text-gray-600 dark:text-gray-400">Enable this for multi-day needs where volunteers can choose specific dates</p>
        </div>
      </div>

      <!-- Recurring -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
        <div class="flex items-start mb-4">
          <%= f.check_box :is_recurring, class: "mt-1 mr-2", data: { action: "change->recurring-need#toggle" } %>
          <div>
            <%= f.label :is_recurring, "Repeat weekly", class: "font-medium" %>
            <p class="text-sm text-gray-600 dark:text-gray-400">Create a recurring event or need that repeats every week on the same day. The End date above will be used as the last occurrence.</p>
          </div>
        </div>

        <div data-recurring-need-target="fields" class="<%= @need.is_recurring? ? '' : 'hidden' %> space-y-4 ml-6 p-4 bg-gray-50 dark:bg-gray-900 rounded-md">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <%= f.label :recurrence_start_day, "Start Day", class: "block text-sm font-medium mb-2" do %>
                Start Day <span class="text-red-600">*</span>
              <% end %>
              <%= f.select :recurrence_start_day,
                  options_for_select([
                    ['Sunday', 0],
                    ['Monday', 1],
                    ['Tuesday', 2],
                    ['Wednesday', 3],
                    ['Thursday', 4],
                    ['Friday', 5],
                    ['Saturday', 6]
                  ], @need.recurrence_start_day),
                  { include_blank: "Select start day" },
                  class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
            </div>
            
            <div>
              <%= f.label :recurrence_end_day, "End Day", class: "block text-sm font-medium mb-2" do %>
                End Day <span class="text-red-600">*</span>
              <% end %>
              <%= f.select :recurrence_end_day,
                  options_for_select([
                    ['Sunday', 0],
                    ['Monday', 1],
                    ['Tuesday', 2],
                    ['Wednesday', 3],
                    ['Thursday', 4],
                    ['Friday', 5],
                    ['Saturday', 6]
                  ], @need.recurrence_end_day),
                  { include_blank: "Select end day" },
                  class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
            </div>
          </div>
          <p class="text-xs text-gray-500">This will repeat weekly from Start Day to End Day. For example, select Monday to Saturday for a weekly event that spans the work week.</p>
        </div>
      </div>

      <!-- Checklist (optional) -->
      <% if @checklists_needs.any? || @checklists_events.any? %>
        <div>
          <%= f.label :checklist_id, "Checklist (Optional)", class: "block text-sm font-medium mb-2" %>
          
          <!-- Needs Checklist -->
          <div data-content-type-target="checklistNeed">
            <%= f.collection_select :checklist_id, @checklists_needs, :id, :name, { include_blank: "No checklist" }, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
            <% if @checklists_needs.empty? %>
              <p class="text-sm text-gray-500 mt-1 italic">No checklists available for needs. <%= link_to "Create one", new_checklist_path, class: "text-teal-600 hover:underline" %></p>
            <% end %>
          </div>
          
          <!-- Events Checklist -->
          <div data-content-type-target="checklistEvent" class="hidden">
            <%= f.collection_select :checklist_id, @checklists_events, :id, :name, { include_blank: "No checklist" }, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
            <% if @checklists_events.empty? %>
              <p class="text-sm text-gray-500 mt-1 italic">No checklists available for events. <%= link_to "Create one", new_checklist_path, class: "text-teal-600 hover:underline" %></p>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Room Booking (for events) -->
      <% if @rooms.any? %>
        <div data-content-type-target="roomBooking" class="<%= @need.event? ? '' : 'hidden' %> border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
          <h3 class="text-lg font-semibold mb-4">Request Room Booking</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Select one or more rooms you'd like to book for this event. Room bookings require admin approval.</p>
          
          <div class="space-y-2">
            <% @rooms.each do |room| %>
              <div class="flex items-start p-3 border border-gray-200 dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-900">
                <%= check_box_tag "room_ids[]", room.id, false, { 
                  id: "room_#{room.id}",
                  class: "mt-1 mr-3"
                } %>
                <%= label_tag "room_#{room.id}", class: "flex-1" do %>
                  <div class="font-medium"><%= room.name %></div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">
                    <%= room.location %><%= " â€¢ " if room.location.present? && room.capacity.present? %><%= "Capacity: #{room.capacity}" if room.capacity.present? %>
                  </div>
                  <% if room.description.present? %>
                    <div class="text-sm text-gray-500 dark:text-gray-500 mt-1"><%= room.description %></div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <div class="mt-4">
            <%= label_tag "room_booking_notes", "Booking Notes (Optional)", class: "block text-sm font-medium mb-2" %>
            <%= text_area_tag "room_booking_notes", "", 
                rows: 3,
                class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700",
                placeholder: "Any special requirements or notes for the room booking..." %>
          </div>
        </div>
      <% end %>

      <!-- Submit Buttons -->
      <div class="flex gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <%= f.submit "Create", class: "px-6 py-3 bg-teal-600 text-white font-semibold rounded-md hover:bg-teal-700 cursor-pointer" %>
        <%= link_to "Cancel", needs_path, class: "px-6 py-3 bg-gray-200 dark:bg-gray-700 font-semibold rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" %>
      </div>

      <% unless Current.user.admin? %>
        <p class="text-sm text-gray-600 dark:text-gray-400 italic">
          Note: Your need will be submitted for admin approval before it becomes visible to other members.
        </p>
      <% end %>
    <% end %>
  </div>
</div>
