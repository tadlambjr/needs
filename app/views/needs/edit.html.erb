<div class="max-w-3xl mx-auto">
  <div class="mb-6">
    <%= link_to need_path(@need), class: "inline-flex items-center text-teal-600 hover:text-teal-800" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to Need
    <% end %>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
    <h1 class="text-3xl font-bold mb-6">Edit <%= @need.event? ? 'Event' : 'Need' %></h1>

    <%= form_with model: @need, class: "space-y-6", data: { controller: "time-slot recurring-need content-type" } do |f| %>
      <%= render "shared/form_errors", object: @need %>

      <!-- Content Type -->
      <div>
        <%= f.label :content_type, "Type", class: "block text-sm font-medium mb-2" %>
        <%= f.select :content_type,
            options_for_select([
              ['Need (Volunteer Opportunity)', 'need'],
              ['Event (RSVP)', 'event']
            ], @need.content_type),
            {},
            class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700",
            data: { action: "change->content-type#toggle", content_type_target: "select" } %>
      </div>

      <!-- Title -->
      <div>
        <%= f.label :title, class: "block text-sm font-medium mb-2" %>
        <%= f.text_field :title, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Description -->
      <div>
        <%= f.label :description, class: "block text-sm font-medium mb-2" do %>
          Description <span class="text-gray-500 font-normal">(Optional)</span>
        <% end %>
        <%= f.text_area :description, rows: 4, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Category -->
      <div>
        <%= f.label :category_id, "Category", class: "block text-sm font-medium mb-2" %>
        <%= f.collection_select :category_id, @categories, :id, :name, {}, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Date Range -->
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <%= f.label :start_date, class: "block text-sm font-medium mb-2" %>
          <%= f.date_field :start_date, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
        </div>
        <div>
          <%= f.label :end_date, class: "block text-sm font-medium mb-2" %>
          <%= f.date_field :end_date, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
        </div>
      </div>

      <!-- Time Slot -->
      <div>
        <%= f.label :time_slot, class: "block text-sm font-medium mb-2" %>
        <%= f.select :time_slot, 
            options_for_select([
              ['Morning (6am-12pm)', 'morning'],
              ['Afternoon (12pm-6pm)', 'afternoon'],
              ['Evening (6pm-10pm)', 'evening'],
              ['All Day', 'all_day'],
              ['Specific Time', 'specific_time']
            ], @need.time_slot), 
            { include_blank: "Select time slot" }, 
            class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700",
            data: { action: "change->time-slot#toggle" } %>
      </div>

      <!-- Specific Time (shown when time_slot is specific_time) -->
      <div data-time-slot-target="specificTime" class="<%= @need.time_slot == 'specific_time' ? '' : 'hidden' %>">
        <%= f.label :specific_time, class: "block text-sm font-medium mb-2" %>
        <%= f.time_field :specific_time, 
            required: @need.time_slot == 'specific_time',
            data: { time_slot_target: "timeInput" },
            class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
        <p class="text-sm text-gray-500 mt-1">Enter the specific time for this need</p>
      </div>

      <!-- Location -->
      <div>
        <%= f.label :location, class: "block text-sm font-medium mb-2" %>
        <%= f.text_field :location, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Volunteer/Attendee Capacity -->
      <div>
        <%= f.label :volunteer_capacity, class: "block text-sm font-medium mb-2" do %>
          <span data-content-type-target="capacityLabel"><%= @need.capacity_label %></span>
        <% end %>
        <%= f.number_field :volunteer_capacity, min: 1, max: 20, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
      </div>

      <!-- Multi-day signup (Needs only) -->
      <div data-content-type-target="mealTrain" class="flex items-start">
        <%= f.check_box :allow_individual_day_signup, class: "mt-1 mr-2" %>
        <div>
          <%= f.label :allow_individual_day_signup, "Allow volunteers to sign up for individual days (Meal Train)", class: "font-medium" %>
          <p class="text-sm text-gray-600 dark:text-gray-400">Enable this for multi-day needs where volunteers can choose specific dates</p>
        </div>
      </div>

      <!-- Recurring Info (Read Only) -->
      <% if @need.is_recurring? %>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
          <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <h3 class="font-semibold mb-2 text-blue-900 dark:text-blue-200">Recurring <%= @need.event? ? 'Event' : 'Need' %></h3>
            <p class="text-sm text-blue-800 dark:text-blue-300">
              <% if @need.recurrence_start_day.present? && @need.recurrence_end_day.present? %>
                <% day_names = %w[Sunday Monday Tuesday Wednesday Thursday Friday Saturday] %>
                This <%= @need.event? ? 'event' : 'need' %> repeats weekly from <%= day_names[@need.recurrence_start_day] %> to <%= day_names[@need.recurrence_end_day] %>.
              <% else %>
                This <%= @need.event? ? 'event' : 'need' %> repeats every <%= @need.recurrence_pattern&.titleize %>.
              <% end %>
              <%= @need.recurrence_end_date ? "Until #{format_date(@need.recurrence_end_date)}" : "Ongoing" %>
            </p>
            <p class="text-xs text-blue-700 dark:text-blue-400 mt-2">
              Recurring settings cannot be edited after creation. Changes to title, description, and other fields will only affect this instance.
            </p>
          </div>
        </div>
      <% end %>

      <!-- Checklist (optional) -->
      <% if @checklists_needs.any? || @checklists_events.any? %>
        <div>
          <%= f.label :checklist_id, "Checklist (Optional)", class: "block text-sm font-medium mb-2" %>
          
          <!-- Needs Checklist -->
          <div data-content-type-target="checklistNeed" class="<%= @need.event? ? 'hidden' : '' %>">
            <%= f.collection_select :checklist_id, @checklists_needs, :id, :name, { include_blank: "No checklist" }, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
            <% if @checklists_needs.empty? %>
              <p class="text-sm text-gray-500 mt-1 italic">No checklists available for needs.</p>
            <% end %>
          </div>
          
          <!-- Events Checklist -->
          <div data-content-type-target="checklistEvent" class="<%= @need.event? ? '' : 'hidden' %>">
            <%= f.collection_select :checklist_id, @checklists_events, :id, :name, { include_blank: "No checklist" }, class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" %>
            <% if @checklists_events.empty? %>
              <p class="text-sm text-gray-500 mt-1 italic">No checklists available for events.</p>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Existing Room Bookings -->
      <% if @need.room_bookings.any? %>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
          <h3 class="text-lg font-semibold mb-4">Current Room Bookings</h3>
          <div class="space-y-3">
            <% @need.room_bookings.each do |booking| %>
              <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 rounded-md">
                <div class="flex-1">
                  <div class="font-medium"><%= booking.room.name %></div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">
                    <%= booking.room.location if booking.room.location.present? %>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <% if booking.approved? %>
                    <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Approved</span>
                  <% elsif booking.rejected? %>
                    <span class="px-2 py-1 text-xs rounded bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Rejected</span>
                  <% else %>
                    <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>
                  <% end %>
                  <%= button_to "Remove", room_booking_path(booking), method: :delete,
                      data: { turbo_confirm: "Remove this room booking?" },
                      class: "text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Submit Buttons -->
      <div class="flex gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <%= f.submit "Update Need", class: "px-6 py-3 bg-teal-600 text-white font-semibold rounded-md hover:bg-teal-700 cursor-pointer" %>
        <%= link_to "Cancel", need_path(@need), class: "px-6 py-3 bg-gray-200 dark:bg-gray-700 font-semibold rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" %>
      </div>
    <% end %>
    
    <!-- Delete Button (outside form to avoid nesting issues) -->
    <% if Current.user.admin? %>
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <%= button_to "Delete Need", need_path(@need), method: :delete, 
            data: { turbo_confirm: "Are you sure you want to delete this need? This action cannot be undone." },
            class: "px-6 py-3 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700" %>
      </div>
    <% end %>
  </div>
</div>
