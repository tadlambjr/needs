<% content_for :title, "Calendar" %>

<div class="max-w-7xl mx-auto">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
    <h1 class="text-2xl sm:text-3xl font-bold">Needs Calendar</h1>
    <%= link_to "Create Need", new_need_path, class: "px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm" %>
  </div>

  <!-- Calendar Navigation -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-4 p-3">
    <div class="flex items-center justify-between">
      <%= link_to calendar_needs_path(start_date: (@current_month - 1.month).to_s), class: "p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" do %>
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      <% end %>
      <div class="text-center">
        <h2 class="text-lg sm:text-xl font-semibold">
          <%= @current_month.strftime("%B %Y") %>
        </h2>
        <%= link_to "Today", calendar_needs_path, class: "text-xs text-indigo-600 dark:text-indigo-400 hover:underline" %>
      </div>
      <%= link_to calendar_needs_path(start_date: (@current_month + 1.month).to_s), class: "p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" do %>
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      <% end %>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
    <!-- Day Headers -->
    <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700">
      <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
        <div class="bg-gray-50 dark:bg-gray-900 p-2 text-center text-xs font-semibold text-gray-700 dark:text-gray-300">
          <span class="hidden sm:inline"><%= day == 'Sun' ? 'Sunday' : day == 'Mon' ? 'Monday' : day == 'Tue' ? 'Tuesday' : day == 'Wed' ? 'Wednesday' : day == 'Thu' ? 'Thursday' : day == 'Fri' ? 'Friday' : 'Saturday' %></span>
          <span class="sm:hidden"><%= day %></span>
        </div>
      <% end %>
    </div>

    <!-- Calendar Days -->
    <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700" style="grid-auto-rows: minmax(120px, auto);">
      <% current_date = @calendar_start %>
      <% while current_date <= @calendar_end %>
        <% day_needs = @calendar_needs.select { |need| need.start_date <= current_date && need.end_date >= current_date } %>
        <% is_today = current_date == Date.today %>
        <% is_current_month = current_date.month == @current_month.month %>
        
        <div class="bg-white dark:bg-gray-800 p-1.5 sm:p-2 overflow-hidden flex flex-col <%= 'bg-blue-50 dark:bg-blue-900/20' if is_today %> <%= 'opacity-40' unless is_current_month %>">
          <div class="text-xs sm:text-sm font-semibold mb-1 <%= 'text-blue-600 dark:text-blue-400' if is_today %> <%= 'text-center sm:text-left' %>">
            <%= current_date.day %>
          </div>
          
          <div class="flex-1 overflow-y-auto space-y-1">
            <% day_needs.first(3).each do |need| %>
              <% user_signed_up = need.need_signups.any? { |signup| signup.user_id == Current.user.id && signup.status.in?(['signed_up', 'waitlist']) } %>
              <%= link_to need_path(need), class: "block text-xs p-1 rounded truncate #{user_signed_up ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600'}", title: need.title do %>
                <span class="hidden sm:inline"><%= need.title %></span>
                <span class="sm:hidden">â€¢</span>
              <% end %>
            <% end %>
            
            <% if day_needs.count > 3 %>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                +<%= day_needs.count - 3 %>
              </div>
            <% end %>
          </div>
        </div>
        
        <% current_date += 1.day %>
      <% end %>
    </div>
  </div>

  <!-- Legend -->
  <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-xs sm:text-sm">
    <div class="flex items-center">
      <div class="h-3 w-3 sm:h-4 sm:w-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded mr-1.5"></div>
      <span>Today</span>
    </div>
    <div class="flex items-center">
      <div class="h-3 w-3 sm:h-4 sm:w-4 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded mr-1.5"></div>
      <span>Your Signups</span>
    </div>
    <div class="flex items-center">
      <div class="h-3 w-3 sm:h-4 sm:w-4 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded mr-1.5"></div>
      <span>Available</span>
    </div>
  </div>
</div>
