<% content_for :title, "Calendar" %>

<div class="max-w-7xl mx-auto">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
    <h1 class="text-2xl sm:text-3xl font-bold">Needs Calendar</h1>
    <%= link_to "Create Need", new_need_path, class: "px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 text-sm" %>
  </div>

  <!-- Calendar Navigation -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-4 p-3">
    <div class="flex items-center justify-between">
      <%= link_to calendar_needs_path(start_date: (@current_month - 1.month).to_s), class: "p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" do %>
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      <% end %>
      <div class="text-center">
        <h2 class="text-lg sm:text-xl font-semibold">
          <%= @current_month.strftime("%B %Y") %>
        </h2>
        <%= link_to "Today", calendar_needs_path, class: "text-xs text-teal-600 dark:text-teal-400 hover:underline" %>
      </div>
      <%= link_to calendar_needs_path(start_date: (@current_month + 1.month).to_s), class: "p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" do %>
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      <% end %>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
    <!-- Day Headers -->
    <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700">
      <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
        <div class="bg-gray-50 dark:bg-gray-900 p-2 text-center text-xs font-semibold text-gray-700 dark:text-gray-300">
          <span class="hidden sm:inline"><%= day == 'Sun' ? 'Sunday' : day == 'Mon' ? 'Monday' : day == 'Tue' ? 'Tuesday' : day == 'Wed' ? 'Wednesday' : day == 'Thu' ? 'Thursday' : day == 'Fri' ? 'Friday' : 'Saturday' %></span>
          <span class="sm:hidden"><%= day %></span>
        </div>
      <% end %>
    </div>

    <!-- Calendar Days Container -->
    <div class="relative bg-gray-200 dark:bg-gray-700">
      <% 
        # Organize dates into weeks for better processing
        weeks = []
        current_date = @calendar_start
        while current_date <= @calendar_end
          week = []
          7.times do
            week << current_date if current_date <= @calendar_end
            current_date += 1.day
          end
          weeks << week
        end
        
        # Create a hash of needs by date for quick lookup
        needs_by_date = Hash.new { |h, k| h[k] = [] }
        @calendar_needs.each do |need|
          date_range = (need.start_date..need.end_date).to_a
          date_range.each do |date|
            if date >= @calendar_start && date <= @calendar_end
              needs_by_date[date] << need
            end
          end
        end
        
        # Create a hash of individual day signups by date
        day_signups_by_date = Hash.new { |h, k| h[k] = [] }
        @day_signups.each do |signup|
          if signup.specific_date
            day_signups_by_date[signup.specific_date] << signup
          end
        end
      %>
      
      <%= render "shared/calendar_grid", 
          weeks: weeks, 
          needs_by_date: needs_by_date,
          day_signups_by_date: day_signups_by_date,
          calendar_start: @calendar_start,
          calendar_end: @calendar_end,
          current_month: @current_month,
          upcoming_signups: @upcoming_signups,
          show_past_opacity: false,
          min_height: 120,
          has_gaps: true %>
    </div>
  </div>

  <!-- Legend -->
  <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-xs sm:text-sm">
    <div class="flex items-center">
      <div class="h-3 w-3 sm:h-4 sm:w-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded mr-1.5"></div>
      <span>Today</span>
    </div>
    <div class="flex items-center">
      <div class="h-3 w-3 sm:h-4 sm:w-4 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded mr-1.5"></div>
      <span>Your Signups</span>
    </div>
    <div class="flex items-center">
      <div class="h-3 w-3 sm:h-4 sm:w-4 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded mr-1.5"></div>
      <span>Available</span>
    </div>
  </div>
</div>
