<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-semibold">6-Week Calendar</h2>
    <%= link_to "Full Calendar View", calendar_needs_path, class: "text-indigo-600 hover:text-indigo-800 text-sm font-medium" %>
  </div>

  <!-- Day headers -->
  <div class="grid grid-cols-7 border-b border-gray-200 dark:border-gray-700">
    <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
      <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-400 py-2">
        <%= day %>
      </div>
    <% end %>
  </div>

  <!-- Calendar grid -->
  <div class="grid grid-cols-7">
    <% 
      # Get all dates for 6 weeks
      weeks = []
      current_date = @calendar_start
      6.times do |week_num|
        week = []
        7.times do
          week << current_date
          current_date = current_date + 1.day
        end
        weeks << week
      end

      # Create a hash of needs by date for quick lookup
      needs_by_date = Hash.new { |h, k| h[k] = [] }
      @calendar_needs.each do |need|
        date_range = (need.start_date..need.end_date).to_a
        date_range.each do |date|
          if date >= @calendar_start && date <= @calendar_end
            needs_by_date[date] << need
          end
        end
      end
    %>

    <% weeks.each do |week| %>
      <% week.each do |date| %>
        <% 
          is_today = date == Date.today
          is_past = date < Date.today
          day_needs = needs_by_date[date]
          is_current_month = date.month == Date.today.month
          user_signed_up = @upcoming_signups.any? { |s| 
            s.specific_date == date || (!s.specific_date && date >= s.need.start_date && date <= s.need.end_date)
          }
        %>
        
        <div class="relative min-h-[100px] sm:min-h-[120px] border-r border-b border-gray-200 dark:border-gray-700 p-1.5 sm:p-2 transition-all hover:bg-gray-50 dark:hover:bg-gray-700/50
                    <%= is_today ? 'bg-indigo-50 dark:bg-indigo-900/20' : '' %>
                    <%= is_past ? 'opacity-50' : '' %>
                    <%= !is_current_month ? 'bg-gray-50 dark:bg-gray-900' : 'bg-white dark:bg-gray-800' %>">
          
          <!-- Date number -->
          <div class="flex items-center justify-between mb-0.5 sm:mb-1">
            <span class="text-xs sm:text-sm font-semibold 
                        <%= is_today ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-700 dark:text-gray-300' %>">
              <%= date.day %>
            </span>
            
            <% if user_signed_up %>
              <span class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-500 rounded-full" title="You're signed up"></span>
            <% end %>
          </div>

          <!-- Needs dots/indicators -->
          <% if day_needs.any? %>
            <div class="space-y-0.5 sm:space-y-1">
              <% day_needs.take(2).each do |need| %>
                <%= link_to need_path(need), class: "block" do %>
                  <div class="text-xs p-0.5 sm:p-1 rounded truncate transition-colors
                              <%= need.full? ? 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400' : 'bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-800' %>"
                       style="border-left: 2px solid <%= need.category.color %>;">
                    <span class="hidden sm:inline"><%= need.title.truncate(15) %></span>
                    <span class="sm:hidden"><%= need.title.truncate(8) %></span>
                  </div>
                <% end %>
              <% end %>
              
              <% if day_needs.count > 2 %>
                <div class="text-xs text-gray-500 dark:text-gray-400 pl-0.5 sm:pl-1">
                  +<%= day_needs.count - 2 %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Legend -->
  <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-4 text-sm">
    <div class="flex items-center">
      <div class="w-4 h-4 border-2 border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 rounded mr-2"></div>
      <span class="text-gray-600 dark:text-gray-400">Today</span>
    </div>
    <div class="flex items-center">
      <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
      <span class="text-gray-600 dark:text-gray-400">You're signed up</span>
    </div>
    <div class="flex items-center">
      <div class="w-4 h-4 bg-indigo-100 dark:bg-indigo-900 rounded mr-2"></div>
      <span class="text-gray-600 dark:text-gray-400">Available needs</span>
    </div>
    <div class="flex items-center">
      <div class="w-4 h-4 bg-gray-200 dark:bg-gray-700 rounded mr-2"></div>
      <span class="text-gray-600 dark:text-gray-400">Full needs</span>
    </div>
  </div>
</div>
